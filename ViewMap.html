<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JW Lib Analytics - All Congregations</title>
    <meta property='og:title' content='JW Lib Analytics - Top Words List'/>
    <meta property='og:image' content='https://comingoutamycage.github.io/JW_Lib_Analytics/examples/SiteExample.png'/>
    <meta property='og:description' content='Examine the scriptures and their usage within JW publications from 1950-2022'/>
    <meta property='og:url' content='https://comingoutamycage.github.io/JW_Lib_Analytics'/>
    <meta property='og:image:width' content='1215' />
    <meta property='og:image:height' content='1148' />

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="js/pace.min.js"></script>
    <link rel="stylesheet" href="js/pace.css">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

    <link href="style.css" rel="stylesheet" />

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="js/functions.js"></script>
    <script src="node_modules/jquery-throttle-debounce/jquery.ba-throttle-debounce.min.js"></script>
    <style>
        .custom-clustericon.has-deleted {
            outline:2px solid rgba(255, 0, 0, 0.85);
            min-width: 30px;
            min-height: 30px;
        }
        .custom-clustericon {
            background: var(--cluster-color);
            color: #fff;
            border-radius: 100%;
            font-weight: bold;
            font-size: 15px;
            display: flex;
            align-items: center;
        }

        .custom-clustericon::before {
            content: "";
            display: block;
            position: absolute;
            width: 100%;
            height: 100%;

            transform: translate(-50%, -50%);
            top: 50%;
            left: 50%;
            background: var(--cluster-color);
            opacity: 0.2;
            border-radius: 100%;
        }

        .custom-clustericon::before {
            padding: 7px;
        }

        .custom-clustericon-1 {
            --cluster-color: rgba(0, 155, 211, 0.8);
        }

        .custom-clustericon-2 {
            --cluster-color: rgba(255, 145, 0, 0.8);
        }

        .custom-clustericon-3 {
            --cluster-color: rgba(213, 21, 21, 0.8);
        }
    </style>
</head>
<body>
<script>InsertNav(true);</script>
<script async src="//static.getclicky.com/101371960.js"></script>

<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/101371960ns.gif" /></p></noscript>
<!--<script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>-->

<!--<script src="https://unpkg.com/supercluster@7.1.2/dist/supercluster.min.js"></script>-->

<!--<link rel="stylesheet" href="node_modules/bootstrap-select/dist/css/bootstrap-select.min.css">-->
<!--<script src="node_modules/bootstrap-select/dist/js/bootstrap-select.min.js"></script>-->

<a class="h3" href="/ViewCongChanges.html">&gt; View List Of Deletions</a><br/><br/>
<a class="h3" href="/ViewHallClosures.html">&gt; View List Of Hall Closures</a><br/><br/>

<div id="translations" style="visibility: hidden; max-height: 0; height: 0; display: block;">
    <div style="height: 0px;">
        <div class="language">Language</div>
        <div class="schedule">Schedule</div>
        <div class="address">Address</div>
        <div class="moved">Moved To</div>
        <div class="CONG">Congregation</div>
        <div class="GROUP">Group</div>
        <div class="PREGROUP">PreGroup</div>
    </div>
</div>

<div style="overflow: hidden;">
    <small><b>Normal:</b> Zoom into the map, and locations will load. Red outlined markers contain deleted.<br/><b>Abandoned Locations</b> are Unique GPS Coordinates that have once hosted a congregation, but no longer do, at that location. (Rounded to nearest 50m)</small>
    <div style="display: flex; gap: 0.3rem; flex-flow: wrap;">
        <div id="stats" style="display: flex; align-items: center; gap: 1rem; flex: 1; flex-flow: wrap; min-width: 300px">
            <h3 style="background: darkgreen; border-radius: 0.2rem; padding:0.2rem; color: white;">Active <span id="total">...</span></h3>
            <h3 style="background: darkred; border-radius: 0.2rem; padding:0.2rem; color: white;">Deleted <span id="totalDeleted">...</span></h3>
            <h3 style="background: darkgreen; border-radius: 0.2rem; padding:0.2rem; color: white;">Active Locations <span id="activeLocations">...</span></h3>
            <h3 style="background: darkred; border-radius: 0.2rem; padding:0.2rem; color: white;">Abandoned Locations <span id="totalOrphans">...</span></h3>
        </div>
    </div>
    <div id="mapHeader" style="display: flex; gap: 0.3rem; flex-flow: wrap;">
        <select id="languages" name="languages" placeholder="Languages"><option value="">All Languages</option></select>
        <button class="btn btn-outline-success active" onclick="NormalMode()">Normal Mode</button>
        <button class="btn btn-outline-dark d-none d-lg-block" onclick="LoadAll()">Load All (HEAVY)</button>
        <button class="btn btn-outline-danger" onclick="LoadDeleted()">Load All Deleted</button>
        <button class="btn btn-outline-danger" onclick="LoadOrphans()">Abandoned Locations</button>
    </div>
    <div style="height: 90vh; width: 100%;">
        <div id="map" style="width: 100%; height: 100%"></div>
    </div>
</div>

<script>
    var map;
    var markers = [];
    var infoWindow;
    var markers = [];
    var markerCluster;
    var currentLanguage;

    var showMarkers = 1;
    var showExpectations = 0;
    var allmeetings = {};
    var minZoom = 4;

    var gridSize = 8;
    var available_grids = [];
    var init_data = {};
    var dead_icon = null;
    function initMap() {
        dead_icon = {
            // url: "images/match-dead.png", // url
            // scaledSize: new google.maps.Size(19, 50), // scaled size
            // anchor: new google.maps.Point(13,50) // anchor
            url: "images/tombstone.png", // url
            scaledSize: new google.maps.Size(27, 38), // scaled size
            anchor: new google.maps.Point(13, 30) // anchor
        };
        
        $.getJSON('./Meetings/init_data.json', (data) => {
            init_data = data;
            available_grids = init_data.grids;
            $("#total").text(init_data.totalActive);
            $("#totalDeleted").text(init_data.totalInactive);
            $("#activeLocations").text(init_data.activeLocations ?? '');
            $("#totalOrphans").text(init_data.totalOrphans);
            $("#stats").append(`<h4>TOTAL RECORDS:</h4>
<h4>Congs: ${init_data.typeTotals.CONG}</h3>
<h4>Groups: ${init_data.typeTotals.GROUP}</h3>
<h4>Pregroups: ${init_data.typeTotals.PREGROUP}</h3>
`);
            let cmbLang = $("#languages")[0];
            for (let [langCode, value] of Object.entries(init_data.languages)){
                let el = document.createElement("option");
                el.textContent = langCode + "\t- " + value.name;
                el.value = langCode;
                cmbLang.appendChild(el);
            }
            $(cmbLang).on('change', function(){
                currentLanguage = this.value;
                reAddmarkers();
            });
            //$(cmbLang).selectpicker({'container': 'body'});
            load();
        });
    }
    function langToName(langCode){
        let row = init_data.languages[langCode];
        if (!row) return langCode;
        return row.name;
    }
    function langsToNames(langCodes){
        if (!langCodes) return "";
        let names = [];
        for (let langCode of langCodes){
            names.push(langToName(langCode));
        }
        return names.join(", ");
    }

    function load() {
        map = new google.maps.Map(document.getElementById("map"), {
            gestureHandling: 'greedy',
            center: new google.maps.LatLng(37, -101),
            zoom: 4,
            mapTypeId: 'roadmap',
            streetViewControl: true,
            mapTypeControlOptions: {style: google.maps.MapTypeControlStyle.DEFAULT}
        });

        infoWindow = new google.maps.InfoWindow();

        // const renderer = {
        //     render: function ({ count, position }, stats) {
        //         // use d3-interpolateRgb to interpolate between red and blue
        //         const color = count > Math.max(10, stats.clusters.markers.mean) ? "#ff0000" : "#0000ff";
        //         const stroke = ' stroke="#ffffff" stroke-width="2"';
        //         const svg = window.btoa(`
        //           <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240">
        //             <circle fill="red" ${stroke} cx="120" cy="120" opacity=".8" r="50" />
        //           </svg>`);
        //         // create svg url with fill color
        //         // create marker using svg icon
        //         return new google.maps.Marker({
        //             position,
        //             icon: {
        //                 url: `data:image/svg+xml;base64,${svg}`,
        //                 scaledSize: new google.maps.Size(75, 75),
        //             },
        //             label: {
        //                 text: String(count),
        //                 color: "rgba(255,255,255,0.9)",
        //                 fontSize: "12px",
        //             },
        //             // adjust zIndex to be above other markers
        //             zIndex: Number(google.maps.Marker.MAX_ZINDEX) + count,
        //         });
        //     }
        // };
        var styles1 = [
            {
                width: 30,
                height: 30,
                className: "custom-clustericon-1",
            },
            {
                width: 35,
                height: 35,
                className: "custom-clustericon-2",
            },
            {
                width: 40,
                height: 40,
                className: "custom-clustericon-3",
            },
        ];
        var styles2 = JSON.parse(JSON.stringify(styles1));
        for (const style of styles2) style.className = style.className + " has-deleted";

        markerCluster = new MarkerClusterer(map, markers,{
            // imagePath: 'images/map-cluster',
            // imageExtension: 'svg',
            gridSize: 40,
            styles: styles1,
            clusterClass: "custom-clustericon",
        });
        setTimeout(function() {
            google.maps.event.addListener(map, 'idle', $.debounce(600, BoundsUpdated));
            google.maps.event.addListener(markerCluster, "click", function (c) {
                console.log('click');
                let markers = c.getMarkers();
                if(markersSamePosition(markers)){
                    let html = '';
                    for (const marker of markers){
                        let meeting = allmeetings[marker.geoId];
                        html += htmlForMeeting(meeting) + "<hr/>";
                    }
                    setTimeout(()=> {
                        infoWindow.setContent(html);
                        infoWindow.setPosition(c.getCenter());
                        infoWindow.open(map);
                    }, 100);
                }
            });
            google.maps.event.addListener(markerCluster, "mouseover", function (c) {
                markerCluster.zoomOnClick_ = !markersSamePosition(c.getMarkers());
                console.log("zoomOnClick", markerCluster.zoomOnClick_);
            });
            google.maps.event.addListener(markerCluster, 'clusteringend', function() {
                setTimeout(()=> {
                    markerCluster.getClusters().forEach(function (cluster) {
                        let anyDead = cluster.getMarkers().some(m =>
                            m.dead
                        );
                        if (anyDead) {
                            let clusterDiv = cluster.clusterIcon_.div_;
                            if (clusterDiv)
                                clusterDiv.classList.add('has-deleted');
                        }
                    });
                }, 200);
            });
            function markersSamePosition(markers){
                if(!markers || markers.length <= 1) return true;
                let p = markers[0].getPosition();
                for (let i = 0; i < markers.length; i++) {
                    if(p.toString() !== markers[i].getPosition().toString())
                        return false;
                }
                return true;
            }

            if(showExpectations){
                DrawExpectations();
            }
        }, 1000);
    }
    function BoundsUpdated(){
        if (showMarkers && map.getZoom() > minZoom) {
            let bounds = map.getBounds();
            let ne = bounds.getNorthEast();
            let sw = bounds.getSouthWest();
            let latMin = roundDownToNearest(sw.lat(), gridSize);
            let latMax = roundUpToNearest(ne.lat(), gridSize);
            let lonMin = roundDownToNearest(sw.lng(), gridSize);
            let lonMax = roundUpToNearest(ne.lng(), gridSize);
            LoadInMarkers(latMin, lonMin, latMax, lonMax);
        }
    }
    function DrawExpectations(){
        $.getJSON('./Meetings/Expectations.json', (expectations) => {
            for(const [key, value] of Object.entries(expectations)){
                DrawExpectation(key, value);
            }
        });
    }
    function DrawExpectation(row, value){
        let coords = row.split(',');
        let color = "#FF0000";
        if(value === '+') color = "#0055ff";
        if(value > 0) color = "#1ebe00";
        const rectangle = new google.maps.Rectangle({
            strokeColor: color,
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: color,
            fillOpacity: 0.15,
            map,
            bounds: {
                north: parseFloat(coords[2]),
                south: parseFloat(coords[0]),
                east: parseFloat(coords[3]),
                west: parseFloat(coords[1]),
            },
        });
    }
    function NormalMode(){
        $("#mapHeader button").removeClass('active');
        $(this).addClass('active');
        clearMarkers();
        available_grids = init_data.grids;
        grids = [];
        BoundsUpdated();
    }
    function LoadAll(){
        $("#mapHeader button").removeClass('active');
        $(this).addClass('active');
        clearMarkers();
        available_grids = [];
        $.getJSON('./Meetings/Meetings.json', function(meetings){
            addMarkers(Object.values(meetings));
        });
    }
    function LoadDeleted(){
        $("#mapHeader button").removeClass('active');
        $(this).addClass('active');
        clearMarkers();
        available_grids = [];
        $.getJSON('./Meetings/grid/deleted.json', function(meetings){
            addMarkers(Object.values(meetings));
        });
    }
    function LoadOrphans(){
        $("#mapHeader button").removeClass('active');
        $(this).addClass('active');
        clearMarkers();
        available_grids = [];
        $.getJSON('./Meetings/grid/orphans.json', function(meetings){
            addMarkers(Object.values(meetings));
        });
    }

    var grids = {};
    function LoadInMarkers(latMin, lonMin, latMax, lonMax){
        if(lonMax < lonMin)
            lonMax += 360;
        else if(lonMin > lonMax)
            lonMin += 360;
        //clearMarkers();
        for(let lat = latMin; lat < latMax; lat += gridSize){
            for(let lon = lonMin; lon < lonMax; lon += gridSize){
                const key = lat.toString() + "," + (lon % 180).toString();
                if (!available_grids.includes(key)) continue;
                if (grids[key] === undefined){
                    grids[key] = true;
                    $.getJSON('./Meetings/grid/' + key + '.json', function(meetings){
                        grids[key] = meetings;
                        addMarkers(meetings);
                    }).fail(function() { delete grids[key]; });
                }/*else if(grids[key] instanceof Object){
                    addMarkers(grids[key]);
                }*/
            }
        }
    }
    var markers = [];
    function addMarkers(meetings){
        let newMarkers = [];
        for (const meeting of meetings)
        {
            allmeetings[meeting.geoId] = meeting;
            if(currentLanguage){
                if(meeting.properties.languageCode !== currentLanguage &&
                    !(meeting.properties.relatedLanguageCodes && meeting.properties.relatedLanguageCodes.includes(currentLanguage)))
                {
                    continue;
                }
            }
            let marker = createMarker(meeting);
            newMarkers.push(marker);
        }
        markerCluster.addMarkers(newMarkers);
        for (let i = 0; i < newMarkers.length; i++) {
            //newMarkers[i].setMap(map);
        }
    }
    function clearMarkers(){
        markerCluster.removeMarkers(markers);
        for (let i = 0; i < markers.length; i++) {
            markers[i].setMap(null);
        }
        markers = [];
    }
    function reAddmarkers(){
        clearMarkers();
        addMarkers(Object.values(allmeetings));
    }

    function searchLocations() {
        var address = $("input[name=addressInput]").val();
        lastQueryLoc = address;
        //alert(address);
        $('#searchCustomers').val("Searching...");

        var geocoder = new google.maps.Geocoder();
        geocoder.geocode({address: address}, function(results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
                searchLocationsNear(results[0].geometry.location);
            } else {
                alert('Location ' + address + ' not found');
            }
            document.getElementById('emailForm').style.display = 'inline';
        });
    }

    function clearLocations() {
        infoWindow.close();
        for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(null);
        }
        markers.length = 0;
    }

    function createMarker(meeting) {
        let name = meeting.properties.orgName;
        let latlng = new google.maps.LatLng(
            parseFloat(meeting.location.latitude),
            parseFloat(meeting.location.longitude));

        let options = {
            //map: map,
            //icon: "../images/mapicon3.png",
            position: latlng,
            title: name,
            geoId: meeting.geoId,
            dead: !meeting.active,
            optimized: true,
        };
        if(!meeting.active){
            options.icon = dead_icon;
        }
        var marker = new google.maps.Marker(options);
        google.maps.event.addListener(marker, 'click', function() {
            let html = htmlForMeeting(meeting);
            infoWindow.setContent(html);
            infoWindow.open(map, marker);
        });
        markers.push(marker);
        return marker;
    }
    function htmlForMeeting(meeting){
        let properties = meeting.properties;
        let state = meeting.active ? "" : " - Deleted<br/><b>Last Seen:</b> " + new Date(meeting.lastSeen).toLocaleDateString();
        let style = meeting.active ? "" : "color:red;";
        let lang = langToName(properties.languageCode);
        if(properties.relatedLanguageCodes) lang += " + " + langsToNames(properties.relatedLanguageCodes);

        let languageDoc = {
            "language": "Language",
            "schedule": "Schedule",
            "address": "Address",
            "moved": "Moved To",
            "CONG": "CONG",
            "GROUP": "GROUP",
            "PREGROUP": "PREGROUP",
        }
        try {
            let translations = $("#translations");
            languageDoc['language'] = translations.find('.language').text();
            languageDoc['schedule'] = translations.find('.schedule').text();
            languageDoc['address'] = translations.find('.address').text();
            languageDoc['moved'] = translations.find('.moved').text();
            languageDoc['CONG'] = translations.find('.CONG').text();
            languageDoc['GROUP'] = translations.find('.GROUP').text();
            languageDoc['PREGROUP'] = translations.find('.PREGROUP').text();
        }catch (e){
            console.log(e);
        }
        let orgType = languageDoc[properties.orgType] || properties.orgType;

        let moved = !meeting.moved ? "" : `<b>${languageDoc['moved']}:</b> ${meeting.moved}<br/>`;
        let html = `
<div style="text-align: left; ${style}">
    ${orgType}<br/>
    <b>${properties.orgName}</b>${state}<br/>
    <b>${languageDoc['language']}:</b> ${lang}<br/>
    <b>${languageDoc['schedule']}:</b> ${properties.schedule || 'Unknown'}<br/>
    <b>${languageDoc['address']}:</b> ${properties.address}<br/>
    ${moved}
</div>`;
        return html;
    }

</script>
<script src="https://maps.google.com/maps/api/js?key=AIzaSyCb4cJ1PN3KmgQw8Kaxt-XIUvXbbFCZsC0&libraries=geometry,marker&callback=initMap" async type="text/javascript"></script>
<script src="node_modules/@googlemaps/markerclustererplus/dist/index.min.js"></script>

</body>
</html>
